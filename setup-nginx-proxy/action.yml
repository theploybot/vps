name: Setup Nginx Proxy (Docker)
description: "Ensure nginx reverse proxy container is running with correct volume mounts for configs + ACME + optional certs"

inputs:
  host:
    description: "VPS hostname or IP"
    required: true
  user:
    description: "SSH username"
    required: true
  port:
    description: "SSH port"
    required: false
    default: "22"

  nginx_container_name:
    description: "Name of nginx container"
    required: false
    default: "nginx_proxy"

  image:
    description: "Nginx image"
    required: false
    default: "nginx:alpine"

  http_port:
    description: "Host port for HTTP"
    required: false
    default: "80"
  https_port:
    description: "Host port for HTTPS"
    required: false
    default: "443"

  sites_dir:
    description: "Host dir containing per-service *.conf files"
    required: false
    default: "/opt/nginx/sites-enabled"
  acme_dir:
    description: "Host dir for ACME challenges"
    required: false
    default: "/var/www/acme-challenges"

  # Optional: mount Let's Encrypt certs from host so nginx can read them
  mount_letsencrypt:
    description: "true|false - mount /etc/letsencrypt into container (read-only)"
    required: false
    default: "false"
  letsencrypt_host_dir:
    description: "Host letsencrypt dir (usually /etc/letsencrypt)"
    required: false
    default: "/etc/letsencrypt"
  letsencrypt_container_dir:
    description: "Container letsencrypt dir (usually /etc/letsencrypt)"
    required: false
    default: "/etc/letsencrypt"

  # Optional: mount a custom cert directory (recommended if you use /opt/nginx/certs)
  mount_certs:
    description: "true|false - mount a host certs directory into container (read-only)"
    required: false
    default: "false"
  certs_host_dir:
    description: "Host certs dir"
    required: false
    default: "/opt/nginx/certs"
  certs_container_dir:
    description: "Container certs dir"
    required: false
    default: "/etc/nginx/certs"

runs:
  using: "composite"
  steps:
    - name: Ensure nginx proxy container is running
      uses: theploybot/vps/ssh-run@v0.0.2
      with:
        host: ${{ inputs.host }}
        user: ${{ inputs.user }}
        port: ${{ inputs.port }}
        script: |
          set -euo pipefail

          NGINX_CONTAINER="${{ inputs.nginx_container_name }}"
          IMAGE="${{ inputs.image }}"
          HTTP_PORT="${{ inputs.http_port }}"
          HTTPS_PORT="${{ inputs.https_port }}"
          SITES_DIR="${{ inputs.sites_dir }}"
          ACME_DIR="${{ inputs.acme_dir }}"

          MOUNT_LE="${{ inputs.mount_letsencrypt }}"
          LE_HOST="${{ inputs.letsencrypt_host_dir }}"
          LE_CONT="${{ inputs.letsencrypt_container_dir }}"

          MOUNT_CERTS="${{ inputs.mount_certs }}"
          CERTS_HOST="${{ inputs.certs_host_dir }}"
          CERTS_CONT="${{ inputs.certs_container_dir }}"

          echo "ðŸ”§ Setting up nginx proxy container: $NGINX_CONTAINER"
          echo "   Image: $IMAGE"
          echo "   Ports: $HTTP_PORT -> 80, $HTTPS_PORT -> 443"
          echo "   Sites: $SITES_DIR"
          echo "   ACME:  $ACME_DIR"
          echo "   Mount letsencrypt: $MOUNT_LE"
          echo "   Mount certs dir:   $MOUNT_CERTS"

          # Ensure docker exists
          if ! command -v docker >/dev/null 2>&1; then
            echo "âŒ Docker is not installed. Run your docker install/provision step first."
            exit 1
          fi

          # Ensure dirs exist
          sudo mkdir -p "$SITES_DIR" "$ACME_DIR"
          sudo chmod 755 "$SITES_DIR" "$ACME_DIR"

          # Ensure a default config exists so nginx can start even before any service is configured
          DEFAULT_CONF="$SITES_DIR/00-default.conf"
          if ! sudo test -f "$DEFAULT_CONF"; then
            echo "ðŸ“ Creating default nginx config at $DEFAULT_CONF"
            sudo tee "$DEFAULT_CONF" >/dev/null <<'CONF'
          server {
              listen 80 default_server;
              server_name _;
              location /.well-known/acme-challenge/ {
                  root /var/www/acme-challenges;
                  try_files $uri =404;
              }
              location / {
                  return 200 "nginx proxy is running\n";
              }
          }
          CONF
          fi

          # Optional mounts
          EXTRA_MOUNTS=()
          if [ "$MOUNT_LE" = "true" ]; then
            if sudo test -d "$LE_HOST"; then
              EXTRA_MOUNTS+=("-v" "$LE_HOST:$LE_CONT:ro")
            else
              echo "âš ï¸ letsencrypt host dir not found: $LE_HOST (skipping mount)"
            fi
          fi

          if [ "$MOUNT_CERTS" = "true" ]; then
            sudo mkdir -p "$CERTS_HOST"
            sudo chmod 755 "$CERTS_HOST"
            EXTRA_MOUNTS+=("-v" "$CERTS_HOST:$CERTS_CONT:ro")
          fi

          # If container exists but not running, start it
          if sudo docker ps -a --format '{{.Names}}' | grep -q "^${NGINX_CONTAINER}$"; then
            if sudo docker ps --format '{{.Names}}' | grep -q "^${NGINX_CONTAINER}$"; then
              echo "âœ… Nginx container already running."
              sudo docker ps --filter "name=$NGINX_CONTAINER" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
              exit 0
            else
              echo "â–¶ï¸ Container exists but not running. Starting..."
              sudo docker start "$NGINX_CONTAINER"
              sudo docker ps --filter "name=$NGINX_CONTAINER" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
              exit 0
            fi
          fi

          echo "ðŸš€ Creating nginx proxy container..."
          sudo docker run -d --name "$NGINX_CONTAINER" \
            --restart unless-stopped \
            -p "$HTTP_PORT:80" \
            -p "$HTTPS_PORT:443" \
            -v "$SITES_DIR:/etc/nginx/conf.d:ro" \
            -v "$ACME_DIR:/var/www/acme-challenges:ro" \
            "${EXTRA_MOUNTS[@]}" \
            "$IMAGE"

          echo "ðŸ” Testing nginx inside container..."
          sudo docker exec "$NGINX_CONTAINER" nginx -t

          echo "âœ… Nginx proxy ready:"
          sudo docker ps --filter "name=$NGINX_CONTAINER" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"